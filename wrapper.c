#include <unistd.h>
#include <stdio.h>
#include <sys/mman.h>
#include <fcntl.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <errno.h>

int loadbin(char *prog, void *binstart)
{
    unsigned int *pa;
    size_t binsize;
    int filedes;
    struct stat statbuf;

    if ((filedes = open(prog, O_RDONLY)) == -1)
    {
        perror("open error :");
        return 1;
    }

    if (fstat (filedes,&statbuf) < 0)
    {
        perror("fstat error");
        return 1;
    }

    binsize = statbuf.st_size;

    if ((pa = mmap(binstart, binsize, PROT_READ|PROT_EXEC, MAP_SHARED | MAP_FIXED, filedes, 0)) == MAP_FAILED)
    {
        printf("errno:0x%x\n", errno);
        perror("mmap error :");
        return 1;
    }

    return 0;
}

int main(int argc, char *argv[])
{
    void *binstart;
    void (*binoep)();

    binstart = (void*)0x10000;
    binoep = (void(*))0x10020;

    if (argc != 2)
    {
        printf("Usage %%prog <name>\n");
        return 0;
    }

    printf("Loading %s\n", argv[1]);
    loadbin(argv[1], binstart);
    
    printf("Execution resumed at oep\n");
    (binoep)();

    return 0;
}
